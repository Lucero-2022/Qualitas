@model Qualitas.Models.DTOs.ReservaDTOs

@section Styles {
    <link rel="stylesheet" href="~/css/tables.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/Reservas.css" asp-append-version="true" />
}

<p class="ultima-actualizacion text-start">
    <span class="badge bg-light text-dark shadow-sm px-3 py-2">
        <i class="bi-clock-history me-2"></i>
        칔ltima actualizaci칩n: @Model.UltimaActualizacion
    </span>
</p>

<div class="dashboard-container">

    <!-- KPIs -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card shadow-sm h-100">
                <div class="card-body text-start">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="text-muted text-uppercase mb-1">Reservas Abiertas</h6>
                            <h3 class="fw-bold text-primario mb-0">@Model.TotalReservas</h3>
                        </div>
                        <i class="bi bi-clipboard-data icon-kpi"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card shadow-sm h-100">
                <div class="card-body text-start">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="text-muted text-uppercase mb-1">Total al ajuste</h6>
                            <h3 class="fw-bold text-primario mb-0">
                                @Model.SumaAjustes.ToString("C", new System.Globalization.CultureInfo("es-MX"))
                            </h3>
                        </div>
                        <i class="bi bi-cash-stack icon-kpi"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card shadow-sm h-100">
                <div class="card-body text-start">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="text-muted text-uppercase mb-1">M치ximo De Hoy</h6>
                            <h3 class="fw-bold text-primario mb-0">
                                @Model.MaximoHoy.ToString("C", new System.Globalization.CultureInfo("es-MX"))
                            </h3>
                        </div>
                        <i class="bi bi-graph-up icon-kpi"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card shadow-sm h-100">
                <div class="card-body text-start">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="text-muted text-uppercase mb-1">Acumulado del mes</h6>
                            <h3 class="fw-bold text-primario mb-0">
                                @Model.SumaMesActual.ToString("C", new System.Globalization.CultureInfo("es-MX"))
                            </h3>
                        </div>
                        <i class="bi bi-calendar-check icon-kpi"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <form method="get" asp-action="Reservas" class="row g-1 align-items-end">
                <div class="col-6 col-md-2">
                    <input type="date" name="fechaDesde" value="@Model.FechaDesde?.ToString("yyyy-MM-dd")"
                        class="form-control form-control-sm" />
                </div>
                <div class="col-6 col-md-2">
                    <input type="date" name="fechaHasta" value="@Model.FechaHasta?.ToString("yyyy-MM-dd")"
                        class="form-control form-control-sm" />
                </div>
                <div class="col-12 col-md-3">
                    <input type="text" name="busqueda" value="@Model.Busqueda" placeholder="Buscar p칩liza o agente"
                        class="form-control form-control-sm" />
                </div>
                <div class="col-12 col-md-3">
                    <select name="oficina" class="form-select form-select-sm">
                        <option value="">Todas las oficinas</option>
                        @foreach (var oficina in Model.Oficinas)
                        {
                            <option value="@oficina.Oficina" selected="@(Model.Oficina == oficina.Oficina)">
                                @oficina.Oficina
                            </option>
                        }
                    </select>
                </div>
                <div class="col-12 col-md-2 d-flex gap-2">
                    <button type="submit" class="btn btn-filtro btn-sm w-100">
                        <i class="bi bi-search me-1"></i> Filtrar
                    </button>
                    <button type="button" class="btn btn-filtro btn-sm w-100" onclick="limpiarFiltros()">
                        <i class="bi bi-x-circle me-1"></i> Limpiar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Tabla -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div id="tabla-reservas">
                @await Html.PartialAsync("_TablaReservas", Model)
            </div>
        </div>
    </div>

    <!-- Gr치ficas -->
    <div class="row mt-4 graficas-row">
        <div class="col-md-6 d-flex">
            <div class="card shadow-sm flex-fill">
                <div class="card-header text-center fw-bold text-primario">
                    Coberturas
                </div>
                <div class="card-body grafica-container">
                    <canvas id="chartCoberturas"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6 d-flex">
            <div class="card shadow-sm flex-fill">
                <div class="card-header text-center fw-bold text-primario">
                    Oficinas
                </div>
                <div class="card-body grafica-container">
                    <canvas id="chartOficinas"></canvas>
                </div>
            </div>
        </div>
    </div> 


    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

@section Scripts {
        <script>
            const charts = {};
            function renderChart(canvasId, type, labels, data, colors) {
                const ctx = document.getElementById(canvasId).getContext("2d");

                new Chart(ctx, {
                    type: type,
                    data: {
                        labels: labels,
                        datasets: [{
                            label: type === "bar" ? "Oficinas" : "Coberturas",
                            data: data,
                            backgroundColor: colors
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: type === "pie", // 游녣 solo en pie
                                position: "bottom"
                            },
                            datalabels: {
                                color: "#000",
                                anchor: type === "pie" ? "center" : "end",
                                align: type === "pie" ? "center" : "top",
                                formatter: (value, context) => {
                                    const dataset = context.chart.data.datasets[0].data;
                                    const total = dataset.reduce((a, b) => a + b, 0);
                                    if (type === "pie") {
                                        const porcentaje = ((value / total) * 100).toFixed(1) + "%";
                                        return porcentaje;
                                    } else if (type === "bar") {
                                        return "$" + value.toLocaleString();
                                    }
                                    return value;
                                }
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            }




            function cargarGraficas() {
                $.get('@Url.Action("DatosGraficas", "Reserva")', {
                    fechaDesde: '@Model.FechaDesde?.ToString("yyyy-MM-dd")',
                    fechaHasta: '@Model.FechaHasta?.ToString("yyyy-MM-dd")',
                    busqueda: '@Model.Busqueda',
                    oficina: '@Model.Oficina'
                }, function (data) {
                    renderChart("chartCoberturas", "pie",
                        data.coberturas.labels,
                        data.coberturas.data,
                        data.coberturas.colors);

                    renderChart("chartOficinas", "bar",
                        data.oficinas.labels,
                        data.oficinas.data,
                        data.oficinas.colors); // 游녣 antes estabas usando [data.oficinas.color]

                });
            }

            $(document).ready(function () {
                cargarGraficas();
            });

            function limpiarFiltros() {
                window.location.href = '@Url.Action("Reservas", "Reserva")';
            }
        </script>
}