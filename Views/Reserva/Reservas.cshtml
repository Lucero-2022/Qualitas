@model Qualitas.Models.DTOs.ReservaDTOs

@section Styles {
    <link rel="stylesheet" href="~/css/tables.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/Reservas.css" asp-append-version="true" />
}

<div class="dashboard-container">

    <!-- Última actualización -->
    <p class="ultima-actualizacion text-start">
        <span class="badge bg-light text-dark shadow-sm px-3 py-2">
            <i class="bi-clock-history me-2"></i>
            Última actualización: @(Model.UltimaActualizacion ?? "N/A")
        </span>
    </p>

    <!-- KPIs -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card shadow-sm h-100">
                <div class="card-body d-flex align-items-center justify-content-between">
                    <div>
                        <h6 class="text-muted text-uppercase mb-1">Reservas Abiertas</h6>
                        <h3 class="fw-bold text-primario mb-0">@Model.TotalReservas</h3>
                    </div>
                    <i class="bi bi-clipboard-data icon-kpi"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm h-100">
                <div class="card-body d-flex align-items-center justify-content-between">
                    <div>
                        <h6 class="text-muted text-uppercase mb-1">Total al ajuste</h6>
                        <h3 class="fw-bold text-primario mb-0">
                            @Model.SumaAjustes.ToString("C", new System.Globalization.CultureInfo("es-MX"))
                        </h3>
                    </div>
                    <i class="bi bi-cash-stack icon-kpi"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm h-100">
                <div class="card-body d-flex align-items-center justify-content-between">
                    <div>
                        <h6 class="text-muted text-uppercase mb-1">Máximo de Hoy</h6>
                        <h3 class="fw-bold text-primario mb-0">
                            @Model.MaximoHoy.ToString("C", new System.Globalization.CultureInfo("es-MX"))
                        </h3>
                    </div>
                    <i class="bi bi-graph-up icon-kpi"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm h-100">
                <div class="card-body d-flex align-items-center justify-content-between">
                    <div>
                        <h6 class="text-muted text-uppercase mb-1">Acumulado del mes</h6>
                        <h3 class="fw-bold text-primario mb-0">
                            @Model.SumaMesActual.ToString("C", new System.Globalization.CultureInfo("es-MX"))
                        </h3>
                    </div>
                    <i class="bi bi-calendar-check icon-kpi"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráficas -->
    <div class="row mt-4 graficas-row">
        <div class="col-md-6 mb-4 d-flex">
            <div class="card shadow-sm flex-fill">
                <div class="card-header text-center fw-bold text-primario">Coberturas</div>
                <div class="card-body grafica-container">
                    <canvas id="chartCoberturas"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-4 d-flex">
            <div class="card shadow-sm flex-fill">
                <div class="card-header text-center fw-bold text-primario">Oficinas</div>
                <div class="card-body grafica-container">
                    <canvas id="chartOficinas"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-12 mb-4 d-flex">
            <div class="card shadow-sm flex-fill card-grafica-grande">
                <div class="card-header text-center fw-bold text-primario">Acumulado del Mes</div>
                <div class="card-body grafica-container">
                    <canvas id="chartAcumuladoMes"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="card shadow-sm my-4">
        <div class="card-body">
            <form method="get" asp-action="Reservas" class="row g-1 align-items-end">
                <div class="col-6 col-md-2">
                    <input type="date" name="fechaDesde" value="@Model.FechaDesde?.ToString("yyyy-MM-dd")"
                        class="form-control form-control-sm" />
                </div>
                <div class="col-6 col-md-2">
                    <input type="date" name="fechaHasta" value="@Model.FechaHasta?.ToString("yyyy-MM-dd")"
                        class="form-control form-control-sm" />
                </div>
                <div class="col-12 col-md-3">
                    <input type="text" name="busqueda" value="@Model.Busqueda" placeholder="Buscar póliza o agente"
                        class="form-control form-control-sm" />
                </div>
                <div class="col-12 col-md-3">
                    <select asp-for="Oficina"
                        asp-items="@(new SelectList(Model.Oficinas ?? new List<Qualitas.Models.DTOs.OficinaDTO>(), "Oficina", "Oficina"))"
                        class="form-select form-select-sm">
                        <option value="">Todas las oficinas</option>
                    </select>
                </div>
                <div class="col-12 col-md-2 d-flex gap-2">
                    <button type="submit" class="btn btn-filtro btn-sm w-100">
                        <i class="bi bi-search me-1"></i> Filtrar
                    </button>
                    <button type="button" class="btn btn-limpiar btn-sm w-100" onclick="limpiarFiltros()">
                        <i class="bi bi-x-circle me-1"></i> Limpiar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Tabla -->
    <div id="tabla-reservas" class="tabla-reservas">
        @await Html.PartialAsync("_TablaReservas", Model)
    </div>

</div>

@section Scripts {
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

    <script>
        // Registrar plugin global
        Chart.register(ChartDataLabels);

        // Función genérica para crear charts tipo línea o barra
        function crearChart(canvasId, tipo, labels = [], data = [], opcionesExtra = {}, colores = []) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return null;
            const ctx = canvas.getContext("2d");

            if (!Array.isArray(labels)) labels = [];
            if (!Array.isArray(data)) data = [];
            if (!Array.isArray(colores) || colores.length !== labels.length) {
                colores = labels.map(() => "#941B80");
            }

            // Destruir instancia previa si existe
            if (canvas._chartInstance) {
                try { canvas._chartInstance.destroy(); } catch { }
            }

            const chart = new Chart(ctx, {
                type: tipo,
                data: {
                    labels,
                    datasets: [{
                        label: opcionesExtra.label || "",
                        data,
                        backgroundColor: tipo === "line" ? (opcionesExtra.backgroundColor || "rgba(148,27,128,0.2)") : colores,
                        borderColor: tipo === "line" ? (opcionesExtra.borderColor || "#941B80") : "transparent",
                        borderWidth: tipo === "line" ? 2 : 1,
                        fill: tipo === "line",
                        tension: tipo === "line" ? 0.4 : 0,
                        pointRadius: tipo === "line" ? 5 : 0,
                        pointBackgroundColor: tipo === "line" ? "#941B80" : undefined,
                        pointBorderColor: tipo === "line" ? "#fff" : undefined,
                        pointBorderWidth: tipo === "line" ? 2 : undefined
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: "bottom", labels: { boxWidth: 12, padding: 8 } },
                        tooltip: { mode: "index", intersect: false },
                        datalabels: {
                            color: "#333",
                            font: { weight: "bold", size: 11 },
                            clip: false,
                            formatter: function (value, context) {
                                if (tipo === "line" || tipo === "bar") return "$" + Number(value).toLocaleString();
                                if (tipo === "doughnut") {
                                    const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    return total ? ((value / total) * 100).toFixed(1) + "%" : "";
                                }
                                return value;
                            }
                        }
                    },
                    scales: tipo === "line"
                        ? { y: { beginAtZero: true, ticks: { callback: v => "$" + Number(v).toLocaleString() } } }
                        : {},
                    ...opcionesExtra
                }
            });

            canvas._chartInstance = chart;
            chart.resize();
            chart.update();
            return chart;
        }

        // Funciones auxiliares para datalabels condicionales (Coberturas y Oficinas)
        function getDatalabelsCoberturas() {
            return {
                color: (ctx) => {
                    const ds = ctx.chart.data.datasets[0].data;
                    const value = ds[ctx.dataIndex];
                    const total = ds.reduce((a, b) => a + b, 0);
                    const pct = total ? (value / total) * 100 : 0;
                    return pct >= 40 ? "#fff" : "#333";
                },
                font: { size: 8, weight: "bold" },
                anchor: (ctx) => { const ds = ctx.chart.data.datasets[0].data; const pct = ds.reduce((a, b) => a + b, 0) ? (ds[ctx.dataIndex] / ds.reduce((a, b) => a + b, 0)) * 100 : 0; return pct >= 40 ? "center" : "end"; },
                align: (ctx) => { const ds = ctx.chart.data.datasets[0].data; const pct = ds.reduce((a, b) => a + b, 0) ? (ds[ctx.dataIndex] / ds.reduce((a, b) => a + b, 0)) * 100 : 0; return pct >= 40 ? "center" : "right"; },
                offset: (ctx) => { const ds = ctx.chart.data.datasets[0].data; const pct = ds.reduce((a, b) => a + b, 0) ? (ds[ctx.dataIndex] / ds.reduce((a, b) => a + b, 0)) * 100 : 0; return pct >= 40 ? 0 : 6; },
                clip: false,
                formatter: (value, context) => {
                    const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                    return total ? ((value / total) * 100).toFixed(1) + "%" : "";
                }
            };
        }

        function getDatalabelsOficinas() {
            return {
                color: (ctx) => {
                    const ds = ctx.chart.data.datasets[0].data;
                    const value = ds[ctx.dataIndex];
                    const max = ds.length ? Math.max(...ds) : 0;
                    return value >= max * 0.5 ? "#fff" : "#333";
                },
                font: { size: 8, weight: "bold" },
                anchor: (ctx) => {
                    const ds = ctx.chart.data.datasets[0].data;
                    const value = ds[ctx.dataIndex];
                    const max = ds.length ? Math.max(...ds) : 0;
                    return value >= max * 0.5 ? "center" : "end";
                },
                align: (ctx) => {
                    const ds = ctx.chart.data.datasets[0].data;
                    const value = ds[ctx.dataIndex];
                    const max = ds.length ? Math.max(...ds) : 0;
                    return value >= max * 0.5 ? "center" : "top";
                },
                offset: (ctx) => {
                    const ds = ctx.chart.data.datasets[0].data;
                    const value = ds[ctx.dataIndex];
                    const max = ds.length ? Math.max(...ds) : 0;
                    return value >= max * 0.5 ? 0 : 4;
                },
                clip: false,
                formatter: (value) => "$" + Number(value).toLocaleString()
            };
        }

        // Cargar gráficos desde backend
        function cargarGraficas() {
            $.get('@Url.Action("DatosGraficas", "Reserva")', {
                fechaDesde: '@Model.FechaDesde?.ToString("yyyy-MM-dd")',
                fechaHasta: '@Model.FechaHasta?.ToString("yyyy-MM-dd")',
                busqueda: '@Model.Busqueda',
                oficina: '@Model.Oficina'
            })
                .done(function (data) {
                    if (!data) return;

                    // Coberturas
                    if (data.coberturas) {
                        crearChart(
                            "chartCoberturas",
                            "bar",
                            data.coberturas.labels || [],
                            data.coberturas.data || [],
                            {
                                indexAxis: "y",
                                plugins: { legend: { display: false }, datalabels: getDatalabelsCoberturas() },
                                scales: {
                                    x: { beginAtZero: true, ticks: { callback: v => Number(v).toLocaleString(), color: "#333", font: { size: 10 } }, grid: { color: "#eee" } },
                                    y: { ticks: { color: "#333", font: { size: 10 } }, grid: { display: false } }
                                }
                            },
                            Array((data.coberturas.labels || []).length).fill("#0096AE")
                        );
                    }

                    // Oficinas
                    if (data.oficinas) {
                        crearChart(
                            "chartOficinas",
                            "bar",
                            data.oficinas.labels || [],
                            data.oficinas.data || [],
                            {
                                plugins: { legend: { display: false }, datalabels: getDatalabelsOficinas() },
                                scales: {
                                    x: { ticks: { color: "#333", font: { size: 10 } }, grid: { display: false } },
                                    y: { beginAtZero: true, ticks: { callback: v => "$" + Number(v).toLocaleString(), color: "#333", font: { size: 10 } }, grid: { color: "#eee" } }
                                }
                            },
                            Array((data.oficinas.labels || []).length).fill("#941B80")
                        );
                    }

                    // Acumulado del mes con gradiente
                    if (data.acumulado) {
                        const canvas = document.getElementById("chartAcumuladoMes");
                        const ctx = canvas.getContext("2d");
                        const gradient = ctx.createLinearGradient(0, 0, 0, canvas.offsetHeight || 360);
                        gradient.addColorStop(0, "rgba(148,27,128,0.25)");
                        gradient.addColorStop(1, "rgba(148,27,128,0)");

                        crearChart(
                            "chartAcumuladoMes",
                            "line",
                            data.acumulado.labels || [],
                            data.acumulado.data || [],
                            {
                                label: "Acumulado del Mes",
                                backgroundColor: gradient,
                                plugins: { legend: { display: false }, datalabels: { display: false } },
                                interaction: { mode: 'nearest', intersect: false },
                                scales: {
                                    y: { beginAtZero: true, suggestedMax: Math.max(...(data.acumulado.data || [0])) * 1.1, ticks: { callback: v => "$" + Number(v).toLocaleString(), color: "#333", font: { size: 10 } }, grid: { color: "#eee" } },
                                    x: { ticks: { color: "#333", font: { size: 10 } }, grid: { display: false } }
                                }
                            }
                        );
                    }

                })
                .fail(function (xhr, status, err) { console.error("Error DatosGraficas:", status, err); });
        }

        $(document).ready(function () { cargarGraficas(); });

        // Limpiar 

        function limpiarFiltros() {
            window.location.href = '@Url.Action("Reservas", "Reserva")';
        }
    </script>
}